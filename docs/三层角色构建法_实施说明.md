# 三层角色构建法 - 实施说明

## ✅ 已完成的实现

### 1. **数据模型扩展** (`podcast.py`)

#### CharacterRole 模型结构
```python
class CharacterRole(BaseModel):
    # === 第一层：核心身份（必填）===
    name: str                          # 角色姓名
    persona: str                       # 人设/身份描述
    core_viewpoint: str                # 核心观点
    voice_description: str             # 音色描述
    tone_description: str              # 语气描述

    # === 第二层：深度构建（可选）===
    # 1. 背景故事
    backstory: Optional[str]           # 关键经历
    backstory_impact: Optional[str]    # 背景如何塑造了角色

    # 2. 沟通风格
    language_habits: Optional[str]     # 语言习惯
    catchphrases: Optional[str]        # 口头禅/常用语
    speech_pace: Optional[str]         # 语速/音调特点

    # 3. 内在价值观与矛盾
    core_values: Optional[str]         # 核心价值观
    inner_contradictions: Optional[str] # 内在矛盾

    # 4. 隐藏动机
    hidden_motivation: Optional[str]   # 隐藏动机/秘密
```

---

### 2. **Prompt生成优化** (`script_generator.py`)

#### 新增方法：`generate_character_persona_prompt()`
- 智能整合角色的核心身份 + 深度构建信息
- 自动检测哪些深度字段已填写
- 生成结构化的人设描述文本

#### 示例输出：

**基础模式**（只填核心身份）：
```
**张伟**：35岁程序员，观点是AI既兴奋又焦虑
```

**完整模式**（填写了深度字段）：
```
**张伟**：35岁程序员，观点是AI既兴奋又焦虑
  - 背景：大学毕业后一直留在北京，经历过几次互联网浪潮（让他对技术趋势敏感，但缺乏安全感）
  - 沟通风格：语言习惯：喜欢用代码打比方；口头禅："这个逻辑是通的"、"简单来说就是"；语速特点：语速偏快，讨论技术问题时会变兴奋
  - 价值观：相信技术能解决一切问题，崇尚逻辑和效率
  - 内在矛盾：是技术理想主义者，但现实中常因办公室政治感到疲惫
  - 隐藏动机：私下里在学写小说，渴望创造有温度的东西
```

---

### 3. **Prompt模板增强**

#### 新增"真实感塑造"指导：
```
## 【核心要求】真实感塑造
1. **体现角色差异**：
   - 如果角色有口头禅，请自然地使用
   - 如果角色有语言习惯，请体现出来
   - 如果角色有内在矛盾，对话中要能感受到这种纠结

2. **角色立体感**：
   - 如果角色有背景故事，可以在对话中自然提及相关经历
   - 如果角色有隐藏动机，可能会不经意流露出相关想法
   - 观点要符合角色的价值观和矛盾心理
```

---

## 🎯 使用方式（渐进式设计）

### **基础模式**（快速生成）
用户只需填写：
- 角色名称
- 人设身份
- 核心观点
- 音色/语气

**适用场景**：快速测试、简单播客

---

### **高级模式**（追求真实感）
用户可以展开"高级设置"，填写：
- 背景故事（关键经历 + 影响）
- 沟通风格（语言习惯 + 口头禅 + 语速）
- 价值观与矛盾
- 隐藏动机

**适用场景**：专业播客、角色深度要求高

---

## 📝 API请求示例

### 基础请求（向后兼容）：
```json
{
  "custom_form": {
    "topic": "AI对未来工作的影响",
    "atmosphere": "serious_deep",
    "characters": [
      {
        "name": "张伟",
        "persona": "35岁程序员",
        "core_viewpoint": "AI既兴奋又焦虑",
        "voice_description": "沉稳",
        "tone_description": "理性、略带焦虑"
      }
    ]
  }
}
```

### 高级请求（使用深度字段）：
```json
{
  "custom_form": {
    "topic": "AI对未来工作的影响",
    "atmosphere": "serious_deep",
    "characters": [
      {
        "name": "张伟",
        "persona": "35岁程序员，在北京打拼",
        "core_viewpoint": "AI是提升效率的终极工具，但也担心被取代",
        "voice_description": "沉稳",
        "tone_description": "理性、略带焦虑",

        // 深度字段
        "backstory": "大学毕业后一直留在北京，经历过几次互联网浪潮，最近刚因项目裁撤换了工作",
        "backstory_impact": "让他对技术趋势非常敏感，同时缺乏安全感",
        "language_habits": "喜欢用代码和技术圈黑话打比方，解释问题时条理清晰",
        "catchphrases": "这个逻辑是通的、简单来说就是",
        "speech_pace": "语速偏快，讨论技术问题时会变得兴奋",
        "core_values": "相信技术能解决一切问题，崇尚逻辑和效率",
        "inner_contradictions": "虽然是技术理想主义者，但现实中常因办公室政治和KPI感到疲惫",
        "hidden_motivation": "私下里在学习写小说，渴望创造一些技术之外的、有温度的东西"
      }
    ]
  }
}
```

---

## 🔧 前端实现建议（待开发）

### 1. **基础表单**（默认展示）
```html
<div class="character-basic">
  <input name="name" placeholder="角色姓名" required>
  <textarea name="persona" placeholder="人设身份" required></textarea>
  <textarea name="core_viewpoint" placeholder="核心观点" required></textarea>
  <select name="voice_description">...</select>
  <input name="tone_description" placeholder="语气风格">

  <button onclick="toggleAdvanced()">展开高级设置 ▼</button>
</div>
```

### 2. **高级表单**（可折叠）
```html
<div class="character-advanced" style="display:none;">
  <h6>📖 背景故事</h6>
  <textarea name="backstory" placeholder="关键经历"></textarea>
  <textarea name="backstory_impact" placeholder="这如何塑造了他"></textarea>

  <h6>🗣️ 沟通风格</h6>
  <textarea name="language_habits" placeholder="语言习惯"></textarea>
  <input name="catchphrases" placeholder="口头禅（用逗号分隔）">
  <input name="speech_pace" placeholder="语速/音调特点">

  <h6>⚖️ 价值观与矛盾</h6>
  <textarea name="core_values" placeholder="核心价值观"></textarea>
  <textarea name="inner_contradictions" placeholder="内在矛盾"></textarea>

  <h6>🔒 隐藏动机</h6>
  <textarea name="hidden_motivation" placeholder="隐藏动机/秘密"></textarea>
</div>
```

### 3. **模板系统**（降低创作门槛）
```javascript
const characterTemplates = {
  "tech_expert": {
    language_habits: "喜欢用技术术语和比喻",
    catchphrases: "从技术角度看、简单来说就是",
    core_values: "相信技术能解决问题，崇尚效率"
  },
  "entrepreneur": {
    language_habits: "直接了当，喜欢讲故事",
    catchphrases: "我举个例子、实际操作中",
    core_values: "结果导向，重视执行力"
  },
  // ...更多模板
};

function applyTemplate(templateId) {
  const template = characterTemplates[templateId];
  // 自动填充字段...
}
```

---

## 🎭 效果对比

### **使用基础字段生成**：
```
张伟：AI确实是个大趋势，我觉得应该积极拥抱。
李芳：我也这么认为，技术进步对社会发展很重要。
```
❌ **问题**：扁平、机械、缺乏个性

### **使用深度字段生成**：
```
张伟：嗯，这个逻辑是通的。你看啊，GPT-4就像是给代码加了个"理解层"，
      简单来说就是能读懂人话了。但说实话，我上周刚看到公司又招了个AI工程师，
      心里还挺慌的...（略显焦虑）

李芳：哈哈，你这个技术宅还会"慌"？不过我倒觉得，会用AI的程序员才是未来。
      就像当年会用IDE的人淘汰了记事本写代码的，对吧？
```
✅ **改进**：有口头禅、有语言习惯、有内在矛盾、有真实感

---

## 🚀 测试步骤

### 1. **测试向后兼容性**
- 用旧API（只有基础字段）创建播客
- 确认能正常生成（不报错）

### 2. **测试深度字段**
- 用新API（填写所有深度字段）创建播客
- 检查生成的对话是否：
  - ✅ 使用了口头禅
  - ✅ 体现了语言习惯
  - ✅ 符合角色的价值观和矛盾
  - ✅ 不同角色明显有差异

### 3. **测试渐进式体验**
- 先只填基础字段 → 生成
- 再填写部分深度字段（如只加口头禅）→ 生成
- 观察质量提升情况

---

## 📊 预期改进

| 指标 | 优化前 | 优化后（使用深度字段）|
|-----|-------|-------------------|
| **角色差异性** | 低（说话风格雷同）| 高（明显个性）|
| **对话真实感** | 中（略显机械）| 高（像真人）|
| **角色立体感** | 低（扁平）| 高（有血有肉）|
| **用户操作复杂度** | 低 | 中（可选高级设置）|

---

## 🎯 下一步计划

1. ✅ **后端模型和Prompt已完成**
2. ⏳ **前端渐进式表单**（待开发）
3. ⏳ **角色模板库**（降低创作门槛）
4. ⏳ **素材上传功能**（自动提取角色信息）

---

## 💡 使用建议

### **快速测试**：
使用基础字段 + 简单的语言习惯和口头禅

### **专业播客**：
尽可能填写完整的深度字段，尤其是：
- 内在矛盾（制造角色张力）
- 口头禅（强化记忆点）
- 背景故事（增加可信度）

**现在就可以通过API测试完整的深度字段功能！** 🚀
