<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量评估系统 - AI虚拟播客工作室</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .progress-ring {
            display: inline-block;
            width: 100px;
            height: 100px;
        }
        .task-card {
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending { background: #ffc107; color: #000; }
        .status-processing { background: #17a2b8; color: #fff; }
        .status-completed { background: #28a745; color: #fff; }
        .status-failed { background: #dc3545; color: #fff; }
        .metric-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }
        .upload-zone.dragover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #28a745;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 顶部导航 -->
        <nav class="navbar navbar-dark mb-4" style="background: rgba(0,0,0,0.3); border-radius: 10px;">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-arrow-left me-2"></i>返回主界面
                </a>
                <span class="navbar-text">
                    <i class="fas fa-chart-bar me-2"></i>批量评估系统
                </span>
            </div>
        </nav>

        <!-- 顶部统计 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-box">
                    <div class="metric-value" id="totalTasks">0</div>
                    <div class="metric-label">总任务数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="metric-value" id="completedTasks">0</div>
                    <div class="metric-label">已完成</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="metric-value" id="processingTasks">0</div>
                    <div class="metric-label">进行中</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-box" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">成功率</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：任务配置和上传 -->
            <div class="col-lg-5">
                <!-- 配置卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>批量任务配置</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#uploadTab">上传文件</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#presetTab">预设场景</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#manualTab">手动输入</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <!-- 上传文件标签页 -->
                            <div id="uploadTab" class="tab-pane fade show active">
                                <div class="upload-zone" id="uploadZone">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: #667eea;"></i>
                                    <h5>拖放文件到这里</h5>
                                    <p class="text-muted">或点击选择文件</p>
                                    <p class="small">支持JSON、CSV格式</p>
                                    <input type="file" id="fileInput" accept=".json,.csv" style="display:none;">
                                </div>
                                <div id="filePreview" class="mt-3" style="display:none;">
                                    <h6>文件内容预览：</h6>
                                    <pre id="fileContent" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
                                </div>
                                <div class="mt-3">
                                    <a href="#" onclick="downloadTemplate('json')" class="btn btn-sm btn-outline-primary me-2">
                                        <i class="fas fa-download me-1"></i>下载JSON模板
                                    </a>
                                    <a href="#" onclick="downloadTemplate('csv')" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>下载CSV模板
                                    </a>
                                </div>
                            </div>

                            <!-- 预设场景标签页 -->
                            <div id="presetTab" class="tab-pane fade">
                                <div class="mb-3">
                                    <label class="form-label">选择预设场景集合：</label>
                                    <select class="form-select" id="presetScenarios">
                                        <option value="demo">演示场景（3个）</option>
                                        <option value="tech">科技类（5个）</option>
                                        <option value="education">教育类（5个）</option>
                                        <option value="business">商业类（5个）</option>
                                        <option value="comprehensive">综合测试（10个）</option>
                                    </select>
                                </div>
                                <button class="btn btn-gradient w-100" onclick="loadPresetScenarios()">
                                    <i class="fas fa-plus-circle me-2"></i>加载预设场景
                                </button>
                            </div>

                            <!-- 手动输入标签页 -->
                            <div id="manualTab" class="tab-pane fade">
                                <div class="mb-3">
                                    <label class="form-label">主题：</label>
                                    <input type="text" class="form-control" id="manualTopic" placeholder="输入播客主题">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">角色数量：</label>
                                    <input type="number" class="form-control" id="manualCharacters" value="2" min="2" max="5">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">目标时长：</label>
                                    <select class="form-select" id="manualDuration">
                                        <option value="3分钟">3分钟</option>
                                        <option value="5分钟" selected>5分钟</option>
                                        <option value="10分钟">10分钟</option>
                                    </select>
                                </div>
                                <button class="btn btn-gradient w-100" onclick="addManualTask()">
                                    <i class="fas fa-plus me-2"></i>添加到任务列表
                                </button>
                            </div>
                        </div>

                        <hr>

                        <!-- 操作按钮 -->
                        <div class="action-buttons">
                            <button class="btn btn-success flex-fill" onclick="startBatchGeneration()" id="startBtn" disabled>
                                <i class="fas fa-play me-2"></i>开始生成
                            </button>
                            <button class="btn btn-warning flex-fill" onclick="pauseGeneration()" id="pauseBtn" disabled>
                                <i class="fas fa-pause me-2"></i>暂停
                            </button>
                            <button class="btn btn-danger flex-fill" onclick="stopGeneration()" id="stopBtn" disabled>
                                <i class="fas fa-stop me-2"></i>停止
                            </button>
                        </div>

                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearAllTasks()">
                            <i class="fas fa-trash me-2"></i>清空任务列表
                        </button>
                    </div>
                </div>

                <!-- 评估配置 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>评估配置</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="autoEvaluate" checked>
                            <label class="form-check-label" for="autoEvaluate">
                                生成完成后自动评估
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="autoDownload" checked>
                            <label class="form-check-label" for="autoDownload">
                                自动下载生成的音频
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="generateReport" checked>
                            <label class="form-check-label" for="generateReport">
                                生成详细评估报告
                            </label>
                        </div>
                        <button class="btn btn-primary w-100" onclick="runEvaluation()" id="evalBtn" disabled>
                            <i class="fas fa-chart-line me-2"></i>开始评估
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：任务列表和结果 -->
            <div class="col-lg-7">
                <!-- 任务列表 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>任务列表</h5>
                        <div>
                            <button class="btn btn-sm btn-light" onclick="refreshTasks()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-light" onclick="downloadAllResults()">
                                <i class="fas fa-download"></i> 下载全部
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div id="taskList">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>还没有任务，请添加任务后开始生成</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评估结果 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>评估结果</h5>
                        <button class="btn btn-sm btn-light" onclick="exportReport()">
                            <i class="fas fa-file-export"></i> 导出报告
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="evaluationResults">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <p>生成完成后将显示评估结果</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // 全局状态
        let tasks = [];
        let isGenerating = false;
        let isPaused = false;

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            initUploadZone();
            updateMetrics();
        });

        // 初始化上传区域
        function initUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        // 处理文件上传
        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    }
                    
                    // 显示预览
                    document.getElementById('filePreview').style.display = 'block';
                    document.getElementById('fileContent').textContent = JSON.stringify(data, null, 2);
                    
                    // 添加到任务列表
                    if (Array.isArray(data)) {
                        data.forEach(item => addTask(item));
                    } else {
                        addTask(data);
                    }
                    
                    alert(`成功导入 ${Array.isArray(data) ? data.length : 1} 个任务！`);
                } catch (error) {
                    alert('文件格式错误：' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // 解析CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index];
                });
                result.push(obj);
            }
            
            return result;
        }

        // 下载模板
        function downloadTemplate(format) {
            let content, filename, mimeType;
            
            if (format === 'json') {
                content = JSON.stringify([
                    {
                        "topic": "人工智能的未来发展",
                        "title": "AI前沿对话",
                        "atmosphere": "serious_deep",
                        "target_duration": "5分钟",
                        "language_style": "formal",
                        "num_characters": 2
                    }
                ], null, 2);
                filename = 'batch_template.json';
                mimeType = 'application/json';
            } else {
                content = 'topic,title,atmosphere,target_duration,language_style,num_characters\n' +
                         '人工智能的未来发展,AI前沿对话,serious_deep,5分钟,formal,2';
                filename = 'batch_template.csv';
                mimeType = 'text/csv';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 加载预设场景
        function loadPresetScenarios() {
            const preset = document.getElementById('presetScenarios').value;
            const scenarios = getPresetScenarios(preset);
            scenarios.forEach(s => addTask(s));
            alert(`成功加载 ${scenarios.length} 个预设场景！`);
        }

        // 获取预设场景
        function getPresetScenarios(preset) {
            const scenarios = {
                demo: [
                    { topic: "人工智能的未来", target_duration: "5分钟", num_characters: 2 },
                    { topic: "健康生活方式", target_duration: "5分钟", num_characters: 2 },
                    { topic: "创业经验分享", target_duration: "5分钟", num_characters: 2 }
                ],
                tech: [
                    { topic: "量子计算技术突破", target_duration: "5分钟", num_characters: 3 },
                    { topic: "区块链应用场景", target_duration: "5分钟", num_characters: 2 },
                    { topic: "5G网络发展趋势", target_duration: "5分钟", num_characters: 2 },
                    { topic: "元宇宙的未来", target_duration: "5分钟", num_characters: 3 },
                    { topic: "自动驾驶技术", target_duration: "5分钟", num_characters: 2 }
                ],
                education: [
                    { topic: "在线教育的变革", target_duration: "5分钟", num_characters: 2 },
                    { topic: "STEM教育的重要性", target_duration: "5分钟", num_characters: 3 },
                    { topic: "终身学习的意义", target_duration: "5分钟", num_characters: 2 },
                    { topic: "教育公平问题", target_duration: "5分钟", num_characters: 3 },
                    { topic: "素质教育改革", target_duration: "5分钟", num_characters: 2 }
                ],
                business: [
                    { topic: "数字化转型策略", target_duration: "5分钟", num_characters: 2 },
                    { topic: "企业创新管理", target_duration: "5分钟", num_characters: 3 },
                    { topic: "可持续发展商业", target_duration: "5分钟", num_characters: 2 },
                    { topic: "供应链优化", target_duration: "5分钟", num_characters: 2 },
                    { topic: "品牌营销策略", target_duration: "5分钟", num_characters: 3 }
                ],
                comprehensive: []
            };
            
            if (preset === 'comprehensive') {
                return [...scenarios.tech, ...scenarios.education, ...scenarios.business].slice(0, 10);
            }
            
            return scenarios[preset] || [];
        }

        // 添加手动任务
        function addManualTask() {
            const topic = document.getElementById('manualTopic').value;
            if (!topic) {
                alert('请输入主题');
                return;
            }
            
            const task = {
                topic: topic,
                target_duration: document.getElementById('manualDuration').value,
                num_characters: parseInt(document.getElementById('manualCharacters').value)
            };
            
            addTask(task);
            document.getElementById('manualTopic').value = '';
            alert('任务已添加到列表！');
        }

        // 添加任务
        function addTask(taskData) {
            const task = {
                id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                ...taskData,
                status: 'pending',
                progress: 0,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(task);
            renderTaskList();
            updateMetrics();
            document.getElementById('startBtn').disabled = false;
        }

        // 渲染任务列表
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>还没有任务，请添加任务后开始生成</p>
                    </div>
                `;
                return;
            }
            
            taskList.innerHTML = tasks.map(task => `
                <div class="task-card card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${task.topic || task.title || '未命名任务'}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${task.target_duration || '5分钟'}
                                    <i class="fas fa-users ms-2 me-1"></i>${task.num_characters || 2}人
                                </small>
                            </div>
                            <span class="status-badge status-${task.status}">${getStatusText(task.status)}</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" style="width: ${task.progress}%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${task.progress}% 完成</small>
                            <div>
                                ${task.status === 'completed' ? `
                                    <button class="btn btn-sm btn-primary" onclick="downloadTask('${task.id}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="evaluateTask('${task.id}')">
                                        <i class="fas fa-star"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger" onclick="removeTask('${task.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                pending: '等待中',
                processing: '生成中',
                completed: '已完成',
                failed: '失败'
            };
            return statusMap[status] || status;
        }

        // 更新统计指标
        function updateMetrics() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const processing = tasks.filter(t => t.status === 'processing').length;
            const failed = tasks.filter(t => t.status === 'failed').length;
            const successRate = total > 0 ? ((completed / (completed + failed || 1)) * 100).toFixed(1) : 0;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('processingTasks').textContent = processing;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // 更新按钮状态
            document.getElementById('evalBtn').disabled = completed === 0;
        }

        // 开始批量生成
        async function startBatchGeneration() {
            if (isGenerating) return;
            
            isGenerating = true;
            isPaused = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            const pendingTasks = tasks.filter(t => t.status === 'pending');
            
            for (const task of pendingTasks) {
                if (!isGenerating) break;
                
                while (isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                await generatePodcast(task);
            }
            
            isGenerating = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            alert('批量生成完成！');
            
            if (document.getElementById('autoEvaluate').checked) {
                runEvaluation();
            }
        }

        // 生成单个播客
        async function generatePodcast(task) {
            task.status = 'processing';
            task.progress = 0;
            renderTaskList();
            updateMetrics();
            
            try {
                // 模拟生成过程（实际应调用API）
                for (let i = 0; i <= 100; i += 10) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    task.progress = i;
                    renderTaskList();
                }
                
                task.status = 'completed';
                task.completedAt = new Date().toISOString();
                
                if (document.getElementById('autoDownload').checked) {
                    // 自动下载
                    console.log('Auto downloading:', task.id);
                }
            } catch (error) {
                task.status = 'failed';
                task.error = error.message;
            }
            
            renderTaskList();
            updateMetrics();
        }

        // 暂停生成
        function pauseGeneration() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').innerHTML = isPaused 
                ? '<i class="fas fa-play me-2"></i>继续'
                : '<i class="fas fa-pause me-2"></i>暂停';
        }

        // 停止生成
        function stopGeneration() {
            if (confirm('确定要停止生成吗？')) {
                isGenerating = false;
                isPaused = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        // 清空任务列表
        function clearAllTasks() {
            if (confirm('确定要清空所有任务吗？')) {
                tasks = [];
                renderTaskList();
                updateMetrics();
                document.getElementById('startBtn').disabled = true;
            }
        }

        // 移除任务
        function removeTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            renderTaskList();
            updateMetrics();
        }

        // 下载任务结果
        function downloadTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            alert('下载任务：' + task.topic);
            // 实际应调用API下载
        }

        // 评估任务
        function evaluateTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            alert('评估任务：' + task.topic);
            // 实际应调用评估API
        }

        // 下载所有结果
        function downloadAllResults() {
            const completed = tasks.filter(t => t.status === 'completed');
            if (completed.length === 0) {
                alert('没有已完成的任务');
                return;
            }
            alert(`准备下载 ${completed.length} 个结果`);
            // 实际应批量下载
        }

        // 运行评估
        async function runEvaluation() {
            const completed = tasks.filter(t => t.status === 'completed');
            if (completed.length === 0) {
                alert('没有已完成的任务可以评估');
                return;
            }
            
            // 显示评估结果
            const resultsDiv = document.getElementById('evaluationResults');
            resultsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary">8.5</h3>
                                <p class="mb-0">平均综合评分</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-success">4.2</h3>
                                <p class="mb-0">平均音质评分</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    评估完成！所有播客质量良好，建议发布。
                </div>
                <canvas id="scoreChart" height="80"></canvas>
            `;
            
            // 绘制图表
            drawScoreChart();
        }

        // 绘制评分图表
        function drawScoreChart() {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tasks.filter(t => t.status === 'completed').map((t, i) => `任务${i+1}`),
                    datasets: [{
                        label: '综合评分',
                        data: Array(tasks.filter(t => t.status === 'completed').length).fill().map(() => 
                            8 + Math.random() * 2
                        ),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        // 导出报告
        function exportReport() {
            const report = {
                generated_at: new Date().toISOString(),
                total_tasks: tasks.length,
                completed: tasks.filter(t => t.status === 'completed').length,
                failed: tasks.filter(t => t.status === 'failed').length,
                tasks: tasks
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evaluation_report_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 刷新任务
        function refreshTasks() {
            renderTaskList();
            updateMetrics();
        }
    </script>
</body>
</html>
